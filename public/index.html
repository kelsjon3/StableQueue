<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MobileSD Interface</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <h1>MobileSD</h1>
        <nav>
            <button id="nav-generator" class="nav-button active">Generator</button>
            <button id="nav-queue" class="nav-button">Queue</button>
            <button id="nav-gallery" class="nav-button">Gallery</button>
            <button id="nav-models" class="nav-button">Models</button>
            <button id="nav-server-setup" class="nav-button">Server Setup</button>
        </nav>
    </header>

    <main id="main-content">

        <section id="generator-view">
            <h2>Image Generation</h2>

            <section id="server-selection-area" class="card">
                <label for="server-alias-select">Target Server:</label>
                <select id="server-alias-select" name="server_alias">
                    <option value="">Loading servers...</option>
                </select>
                <span id="server-status"></span>
            </section>

            <section id="civitai-integration-area" class="card">
                <h3>Civitai Helper</h3>
                <label for="civitai-image-id">Civitai Image ID:</label>
                <input type="text" id="civitai-image-id" name="civitai_image_id">
                <button id="fetch-civitai-info-btn">Fetch & Populate</button>
                <div id="civitai-resources-list"></div>
            </section>

            <section id="generation-params" class="card">
                <h3>Generation Parameters</h3>
                <div class="form-group">
                    <label for="positive-prompt">Positive Prompt:</label>
                    <textarea id="positive-prompt" name="positive_prompt" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="negative-prompt">Negative Prompt:</label>
                    <textarea id="negative-prompt" name="negative_prompt" rows="2"></textarea>
                </div>
                <div class="grid-container">
                    <div class="form-group">
                        <label for="style-preset">Style Preset:</label>
                        <input type="text" id="style-preset" name="style_preset" value="simple">
                    </div>
                    <div class="form-group">
                        <label for="sampler-name">Sampler Name:</label>
                        <input type="text" id="sampler-name" name="sampler_name" value="Euler">
                    </div>
                    <div class="form-group">
                        <label for="steps">Steps:</label>
                        <input type="number" id="steps" name="steps" value="20" min="1" max="150">
                    </div>
                    <div class="form-group">
                        <label for="cfg-scale">CFG Scale:</label>
                        <input type="number" id="cfg-scale" name="cfg_scale" value="7.0" step="0.1" min="1">
                    </div>
                     <div class="form-group">
                        <label for="width">Width:</label>
                        <input type="number" id="width" name="width" value="512" step="64">
                    </div>
                     <div class="form-group">
                        <label for="height">Height:</label>
                        <input type="number" id="height" name="height" value="512" step="64">
                    </div>
                    <div class="form-group">
                        <label for="seed">Seed (-1 for random):</label>
                        <input type="text" id="seed" name="seed" value="">
                    </div>
                    <div class="form-group">
                        <label for="subseed">Subseed (-1 for random):</label>
                        <input type="text" id="subseed" name="subseed" value="">
                    </div>
                    <div class="form-group">
                        <label for="num-images">Number of Images:</label>
                        <input type="number" id="num-images" name="num_images" value="1" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label for="sampling-category">Sampling Category:</label>
                        <input type="text" id="sampling-category" name="sampling_category" value="Both">
                    </div>
                    <div class="form-group">
                        <label for="upscaler-model">Upscaler Model:</label>
                        <input type="text" id="upscaler-model" name="upscaler_model" value="None">
                    </div>
                    <div class="form-group">
                        <label for="refiner-model">Refiner Model:</label>
                        <input type="text" id="refiner-model" name="refiner_model" value="None">
                    </div>
                    <div class="form-group">
                        <label for="scheduler-or-quality-preset">Scheduler/Quality Preset:</label>
                        <input type="text" id="scheduler-or-quality-preset" name="scheduler_or_quality_preset" value="Balanced">
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="prompt-matrix-variation-toggle" name="prompt_matrix_variation_toggle">
                        <label for="prompt-matrix-variation-toggle">Prompt Matrix/Variation</label>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="enable-hires-fix" name="enable_hires_fix">
                        <label for="enable-hires-fix">Enable Hires. Fix</label>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="restore-faces" name="restore_faces">
                        <label for="restore-faces">Restore Faces</label>
                    </div>
                    <!-- 
                        Hiding resize_method_txt2img for now as its use is tied to hires fix or presets
                        It was "Crop and Resize" in HAR data index 16.
                    <div class="form-group">
                        <label for="resize-method-txt2img">Resize Method (txt2img):</label>
                        <input type="text" id="resize-method-txt2img" name="resize_method_txt2img" value="Crop and Resize">
                    </div>
                    -->
                </div>
            </section>

            <section id="lora-selection-area" class="card">
                <h3>LoRAs</h3>
                <div id="lora-rows-container">
                </div>
                 <button id="add-lora-btn">+ Add LoRA</button>
                 <div id="lora-row-template" style="display: none;" class="lora-row grid-container">
                     <select class="lora-select">
                         <option value="">Select LoRA...</option>
                     </select>
                     <input type="number" class="lora-weight" value="0.8" step="0.1" min="-1" max="2">
                     <button class="remove-lora-btn">Remove</button>
                 </div>
            </section>
            
            <section id="checkpoint-selection-area" class="card">
                 <h3>Checkpoint</h3>
                 <select id="checkpoint-select" name="checkpoint_name">
                     <option value="">Loading checkpoints...</option>
                 </select>
            </section>

            <section id="action-area">
                <button id="generate-btn" class="primary-button">Generate Image</button>
            </section>

            <section id="progress-area" class="card">
                <h3>Progress</h3>
                <progress id="progress-bar" value="0" max="100"></progress>
                <p id="progress-text">Idle</p>
                <img id="progress-image-preview" src="#" alt="Progress Preview" style="display: none; max-width: 256px;">
            </section>

            <section id="output-area" class="card">
                <h3>Output</h3>
                <div id="output-image-container">
                </div>
                 <div id="output-info">
                 </div>
            </section>

        </section>

        <section id="queue-view" style="display: none;">
            <h2>Job Queue</h2>
            
            <div id="queue-controls" class="card">
                <button id="refresh-queue-btn" class="secondary-button">Refresh Queue</button>
                <div class="queue-filter">
                    <label for="queue-status-filter">Status:</label>
                    <select id="queue-status-filter">
                        <option value="">All Jobs</option>
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="completed">Completed</option>
                        <option value="failed">Failed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
            </div>
            
            <div id="queue-container" class="card">
                <table id="queue-table">
                    <thead>
                        <tr>
                            <th>Job ID</th>
                            <th>Status</th>
                            <th>Server</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="queue-jobs">
                        <!-- Job rows will be inserted here dynamically -->
                    </tbody>
                </table>
                <div id="queue-loading">Loading jobs...</div>
                <div id="queue-empty" style="display: none;">No jobs found.</div>
            </div>
            
            <div id="job-details-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <div class="modal-body">
                        <h3>Job Details</h3>
                        <div id="job-details-content"></div>
                        <div id="job-actions">
                            <button id="cancel-job-btn" class="danger-button">Cancel Job</button>
                            <button id="delete-job-btn" class="danger-button">Delete Job</button>
                            <button id="view-job-results-btn" class="secondary-button">View Results</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="gallery-view" style="display: none;">
            <h2>Image Gallery</h2>
            
            <div id="gallery-controls" class="card">
                <button id="refresh-gallery-btn" class="secondary-button">Refresh Gallery</button>
                <div class="gallery-filter">
                    <label for="gallery-search">Search:</label>
                    <input type="text" id="gallery-search" placeholder="Filter by filename...">
                </div>
            </div>
            
            <div id="gallery-container" class="card">
                <div id="gallery-images"></div>
                <div id="gallery-loading">Loading images...</div>
                <div id="gallery-empty" style="display: none;">No images found.</div>
            </div>
            
            <div id="image-viewer-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <div class="modal-body">
                        <img id="modal-image" src="" alt="Full size image">
                        <div id="modal-image-info"></div>
                        <button id="delete-image-btn" class="danger-button">Delete Image</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="models-view" style="display: none;">
            <h2>Model Library</h2>
            
            <div id="models-controls" class="card">
                <button id="refresh-models-btn" class="secondary-button">Refresh Models</button>
                
                <div class="models-filters">
                    <div class="filter-group">
                        <label for="model-type-filter">Type:</label>
                        <select id="model-type-filter">
                            <option value="">All Models</option>
                            <option value="checkpoint">Checkpoints</option>
                            <option value="lora">LoRAs</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="base-model-filter">Base Model:</label>
                        <select id="base-model-filter">
                            <option value="">All Base Models</option>
                            <!-- Base model options will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="model-search">Search:</label>
                        <input type="text" id="model-search" placeholder="Search models...">
                    </div>
                </div>
            </div>
            
            <div id="models-container" class="card">
                <div id="models-grid"></div>
                <div id="models-loading">Loading models...</div>
                <div id="models-empty" style="display: none;">No models found.</div>
            </div>
            
            <div id="model-details-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <div class="modal-body">
                        <div id="model-preview-container">
                            <img id="model-preview-image" src="" alt="Model preview">
                        </div>
                        <div id="model-info">
                            <h3 id="model-name"></h3>
                            <div class="model-meta">
                                <span id="model-type-badge" class="badge"></span>
                                <span id="model-base-badge" class="badge"></span>
                            </div>
                            <p id="model-description"></p>
                            <div id="model-details"></div>
                            <div id="model-actions">
                                <a id="model-civitai-link" href="#" target="_blank" class="button secondary-button">View on Civitai</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="server-setup-view" style="display: none;">
            <h2>Server Configuration</h2>
             <div id="server-list-container" class="card">
                 <h3>Existing Servers</h3>
                 <ul id="server-list"></ul>
             </div>
             <div id="add-server-form-container" class="card">
                 <h3>Add/Edit Server</h3>
                 <form id="server-form">
                     <input type="hidden" id="edit-alias" value="">
                     <div class="form-group">
                         <label for="server-alias">Alias:</label>
                         <input type="text" id="server-alias" required>
                     </div>
                     <div class="form-group">
                         <label for="server-api-url">API URL (e.g., http://host:port):</label>
                         <input type="url" id="server-api-url" required>
                     </div>
                     <div class="form-group">
                         <label>Authentication (Basic Auth):</label>
                         <div>
                            <label for="server-auth-user">Username:</label>
                            <input type="text" id="server-auth-user">
                         </div>
                          <div>
                            <label for="server-auth-pass">Password:</label>
                            <input type="password" id="server-auth-pass">
                         </div>
                         <small>Leave blank for no authentication.</small>
                     </div>
                     <button type="submit" id="save-server-btn" class="primary-button">Save Server</button>
                     <button type="button" id="cancel-edit-btn" style="display: none;">Cancel Edit</button>
                 </form>
             </div>
        </section>

    </main>

    <footer>
        <p>MobileSD Interface</p>
    </footer>

    <script src="js/app.js"></script>
</body>
</html>
